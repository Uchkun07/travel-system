name: 【Bot】提交分支时创建PR

on:
  push:
    branches-ignore:
      - "**release**"

permissions:
  contents: read
  pull-requests: read

jobs:
  open-pr-if-ahead:
    # 跳过 main、自定义跳过关键字
    if: github.ref_type == 'branch' &&
      github.ref_name != 'main' &&
      !contains(github.event.head_commit.message, '[skip pr]')
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      # 比较差异：只有 head 分支相对 base=main 有提交（ahead_by>0）才继续
      - name: Compare with main
        id: cmp
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PR_BOT_TOKEN }}
          script: |
            const owner = context.repo.owner;
            const repo  = context.repo.repo;
            const head  = context.ref.replace('refs/heads/','');
            const base  = 'main';

            const { data: compare } = await github.rest.repos.compareCommitsWithBasehead({
              owner, repo, basehead: `${base}...${head}`
            });
            core.setOutput('ahead', String(compare.ahead_by));
            core.setOutput('behind', String(compare.behind_by));
            console.log(`ahead_by=${compare.ahead_by}, behind_by=${compare.behind_by}`);

      - name: Stop if not ahead
        if: steps.cmp.outputs.ahead == '0'
        run: echo "No diff ahead of main; skip creating PR." && exit 0

      # 确保存在唯一的 head->main PR（已存在就复用，不重复创建）
      - name: Ensure PR exists (author = fixed account)
        id: ensure
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PR_BOT_TOKEN }}
          script: |
            const owner = context.repo.owner;
            const repo  = context.repo.repo;
            const headBranch = context.ref.replace('refs/heads/','');
            const head = `${owner}:${headBranch}`;
            const base = 'main';

            // 获取第一个领先 commit 的 message
            const { data: compare } = await github.rest.repos.compareCommitsWithBasehead({
              owner, repo, basehead: `${base}...${headBranch}`
            });
            const firstMessage = compare.commits[0]?.commit.message || `Merge ${headBranch} to ${base}`;
            const title = firstMessage.split('\n')[0]; // 只取第一行

            // 查找是否已有开放 PR
            const { data: prs } = await github.rest.pulls.list({ owner, repo, state: 'open', head, base });
            if (prs.length) {
              core.info(`PR exists: #${prs[0].number}`);
              core.setOutput('pr', String(prs[0].number));
            } else {
              const res = await github.rest.pulls.create({ owner, repo, title, head, base });
              core.info(`PR created: #${res.data.number}`);
              core.setOutput('pr', String(res.data.number));
            }
