name: ã€Botã€‘è‡ªåŠ¨åˆ›å»ºPR

on:
  push:
    branches-ignore:
      - "main"
      - "**release**"

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  auto-create-pr:
    # è·³è¿‡ main åˆ†æ”¯å’ŒåŒ…å« [skip pr] çš„æäº¤
    if: github.ref_type == 'branch' &&
      github.ref_name != 'main' &&
      !contains(github.event.head_commit.message, '[skip pr]')
    runs-on: ubuntu-latest

    steps:
      - name: Checkout ä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # æ¯”è¾ƒå½“å‰åˆ†æ”¯ä¸ main çš„å·®å¼‚
      - name: æ£€æŸ¥åˆ†æ”¯å·®å¼‚
        id: check_diff
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const head = context.ref.replace('refs/heads/', '');
            const base = 'main';

            console.log(`æ­£åœ¨æ¯”è¾ƒ ${base}...${head}`);

            try {
              const { data: compare } = await github.rest.repos.compareCommitsWithBasehead({
                owner,
                repo,
                basehead: `${base}...${head}`
              });
              
              const aheadBy = compare.ahead_by;
              const behindBy = compare.behind_by;
              
              core.setOutput('ahead', String(aheadBy));
              core.setOutput('behind', String(behindBy));
              
              console.log(`âœ“ ahead_by=${aheadBy}, behind_by=${behindBy}`);
              
              if (aheadBy === 0) {
                console.log('âš  å½“å‰åˆ†æ”¯æ²¡æœ‰æ–°æäº¤ï¼Œè·³è¿‡åˆ›å»º PR');
              }
            } catch (error) {
              core.setFailed(`æ¯”è¾ƒåˆ†æ”¯å¤±è´¥: ${error.message}`);
            }

      - name: ç»ˆæ­¢ï¼ˆæ— æ–°æäº¤ï¼‰
        if: steps.check_diff.outputs.ahead == '0'
        run: |
          echo "ğŸ“‹ å½“å‰åˆ†æ”¯ç›¸å¯¹äº main æ²¡æœ‰æ–°çš„æäº¤"
          echo "âœ“ è·³è¿‡åˆ›å»º PR"
          exit 0

      # åˆ›å»ºæˆ–æ›´æ–° PR
      - name: åˆ›å»ºæˆ–æ›´æ–° PR
        if: steps.check_diff.outputs.ahead != '0'
        id: create_pr
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const headBranch = context.ref.replace('refs/heads/', '');
            const head = `${owner}:${headBranch}`;
            const base = 'main';

            // è·å–ç¬¬ä¸€ä¸ªæäº¤çš„æ¶ˆæ¯ä½œä¸º PR æ ‡é¢˜
            const { data: compare } = await github.rest.repos.compareCommitsWithBasehead({
              owner,
              repo,
              basehead: `${base}...${headBranch}`
            });

            const firstCommit = compare.commits[0];
            const commitMessage = firstCommit?.commit.message || `åˆå¹¶ ${headBranch} åˆ° ${base}`;
            const title = commitMessage.split('\n')[0]; // å–ç¬¬ä¸€è¡Œä½œä¸ºæ ‡é¢˜

            // ç”Ÿæˆ PR æè¿°
            const commitCount = compare.commits.length;
            const filesChanged = compare.files?.length || 0;

            let body = `## ğŸ“ å˜æ›´æ‘˜è¦\n\n`;
            body += `- **åˆ†æ”¯**: \`${headBranch}\` â†’ \`${base}\`\n`;
            body += `- **æäº¤æ•°**: ${commitCount} ä¸ªæäº¤\n`;
            body += `- **æ–‡ä»¶å˜æ›´**: ${filesChanged} ä¸ªæ–‡ä»¶\n\n`;
            body += `## ğŸ“‹ æäº¤å†å²\n\n`;

            compare.commits.slice(0, 10).forEach(commit => {
              const msg = commit.commit.message.split('\n')[0];
              const sha = commit.sha.substring(0, 7);
              const author = commit.commit.author.name;
              body += `- \`${sha}\` ${msg} - *${author}*\n`;
            });

            if (commitCount > 10) {
              body += `\n... è¿˜æœ‰ ${commitCount - 10} ä¸ªæäº¤\n`;
            }

            body += `\n---\nğŸ¤– æ­¤ PR ç”± GitHub Actions è‡ªåŠ¨åˆ›å»º`;

            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨å¼€æ”¾çš„ PR
            const { data: existingPRs } = await github.rest.pulls.list({
              owner,
              repo,
              state: 'open',
              head,
              base
            });

            if (existingPRs.length > 0) {
              const prNumber = existingPRs[0].number;
              console.log(`âœ“ PR å·²å­˜åœ¨: #${prNumber}`);
              console.log(`ğŸ“ URL: ${existingPRs[0].html_url}`);
              
              // æ›´æ–°ç°æœ‰ PR
              await github.rest.pulls.update({
                owner,
                repo,
                pull_number: prNumber,
                title,
                body
              });
              
              core.setOutput('pr_number', String(prNumber));
              core.setOutput('pr_url', existingPRs[0].html_url);
              core.setOutput('action', 'updated');
              
              // æ·»åŠ è¯„è®º
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: prNumber,
                body: `ğŸ”„ PR å·²æ›´æ–°\n\næ–°å¢ ${commitCount} ä¸ªæäº¤ï¼Œä¿®æ”¹ ${filesChanged} ä¸ªæ–‡ä»¶ã€‚`
              });
            } else {
              // åˆ›å»ºæ–° PR
              const { data: newPR } = await github.rest.pulls.create({
                owner,
                repo,
                title,
                head,
                base,
                body
              });
              
              console.log(`âœ… PR åˆ›å»ºæˆåŠŸ: #${newPR.number}`);
              console.log(`ğŸ“ URL: ${newPR.html_url}`);
              
              core.setOutput('pr_number', String(newPR.number));
              core.setOutput('pr_url', newPR.html_url);
              core.setOutput('action', 'created');
              
              // æ·»åŠ æ ‡ç­¾
              await github.rest.issues.addLabels({
                owner,
                repo,
                issue_number: newPR.number,
                labels: ['ğŸ¤– auto-pr']
              });
            }

      - name: è¾“å‡ºç»“æœ
        if: steps.create_pr.outputs.pr_number
        run: |
          echo "ğŸ‰ æ“ä½œå®Œæˆï¼"
          echo "ğŸ“Œ PR #${{ steps.create_pr.outputs.pr_number }}"
          echo "ğŸ”— ${{ steps.create_pr.outputs.pr_url }}"
          echo "âœ¨ åŠ¨ä½œ: ${{ steps.create_pr.outputs.action }}"
